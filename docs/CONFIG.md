# BumbleCore é…ç½®å‚æ•°è¯´æ˜

BumbleCore æ”¯æŒé€šè¿‡ YAML é…ç½®æ–‡ä»¶æˆ–å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œé…ç½®ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†æ‰€æœ‰å¯ç”¨çš„é…ç½®å‚æ•°ã€‚

> ğŸ’¡ **é…ç½®ä¼˜å…ˆçº§**ï¼šå‘½ä»¤è¡Œå‚æ•° > YAML é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼

---

## ğŸ“‹ ç›®å½•

- [è®­ç»ƒå‚æ•°](#è®­ç»ƒå‚æ•°)
  - [åŸºç¡€é…ç½®](#ğŸ¯-åŸºç¡€é…ç½®)
  - [æ¨¡å‹å’Œåˆ†è¯å™¨](#ğŸ¤–-æ¨¡å‹å’Œåˆ†è¯å™¨)
  - [æ•°æ®é›†é…ç½®](#ğŸ“Š-æ•°æ®é›†é…ç½®)
  - [è®­ç»ƒè¶…å‚æ•°](#ğŸ“-è®­ç»ƒè¶…å‚æ•°)
  - [æ‰¹æ¬¡å¤§å°](#ğŸ’¾-æ‰¹æ¬¡å¤§å°)
  - [ç²¾åº¦è®¾ç½®](#ğŸ”¢-ç²¾åº¦è®¾ç½®)
  - [DeepSpeed å’Œåˆ†å¸ƒå¼](#ğŸš€-deepspeed-å’Œåˆ†å¸ƒå¼)
  - [ä¿å­˜å’Œæ£€æŸ¥ç‚¹](#ğŸ’¾-ä¿å­˜å’Œæ£€æŸ¥ç‚¹-1)
  - [æ—¥å¿—é…ç½®](#ğŸ“ˆ-æ—¥å¿—é…ç½®)
  - [LoRA é…ç½®](#ğŸ”§-lora-é…ç½®)
  - [DPO ç‰¹å®šå‚æ•°](#ğŸ¯-dpo-ç‰¹å®šå‚æ•°)
- [æ¨ç†å‚æ•°](#æ¨ç†å‚æ•°)
  - [æ¨¡å‹åŠ è½½é…ç½®](#ğŸ¤–-æ¨¡å‹åŠ è½½é…ç½®-1)
  - [å¯¹è¯åŸºç¡€é…ç½®](#ğŸ’¬-å¯¹è¯åŸºç¡€é…ç½®)
  - [é‡‡æ ·ç”Ÿæˆå‚æ•°](#ğŸ²-é‡‡æ ·ç”Ÿæˆå‚æ•°)
  - [Web æœåŠ¡é…ç½®](#ğŸŒ-web-æœåŠ¡é…ç½®ä»…-bumblechat-ä½¿ç”¨)

---

## è®­ç»ƒå‚æ•°

### ğŸ¯ åŸºç¡€é…ç½®

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `yaml_config` | str | "" | YAML é…ç½®æ–‡ä»¶è·¯å¾„ |
| `training_stage` | str | "sft" | è®­ç»ƒé˜¶æ®µï¼š`pretrain`ï¼ˆé¢„è®­ç»ƒï¼‰ã€`continue_pretrain`ï¼ˆå¢é‡é¢„è®­ç»ƒï¼‰ã€`sft`ï¼ˆç›‘ç£å¾®è°ƒï¼‰ã€`dpo`ï¼ˆç›´æ¥åå¥½ä¼˜åŒ–ï¼‰ |
| `finetuning_type` | str | "full" | å¾®è°ƒç±»å‹ï¼š`full`ï¼ˆå…¨å‚æ•°å¾®è°ƒï¼‰ã€`lora`ï¼ˆLoRA å¾®è°ƒï¼‰ |
| `output_dir` | str | "./output" | æ¨¡å‹å’Œæ—¥å¿—è¾“å‡ºç›®å½• |

**ä½¿ç”¨è¯´æ˜ï¼š**
- `training_stage` å†³å®šäº†æ•°æ®å¤„ç†æ–¹å¼å’ŒæŸå¤±å‡½æ•°è®¡ç®—æ–¹å¼
- `finetuning_type` ä¸º `lora` æ—¶ï¼Œéœ€è¦é…ç½® [LoRA ç›¸å…³å‚æ•°](#-lora-é…ç½®)

---

### ğŸ¤– æ¨¡å‹å’Œåˆ†è¯å™¨

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `model_name_or_path` | str | None | æ¨¡å‹è·¯å¾„æˆ– HuggingFace æ¨¡å‹åç§°ï¼ˆå¿…å¡«ï¼‰ |
| `trust_remote_code` | bool | False | æ˜¯å¦ä¿¡ä»»è¿œç¨‹ä»£ç ï¼ˆä½¿ç”¨è‡ªå®šä¹‰æ¨¡å‹æ—¶éœ€è¦ï¼‰ |
| `tokenizer_use_fast` | bool | False | æ˜¯å¦ä½¿ç”¨å¿«é€Ÿåˆ†è¯å™¨ |

---

### ğŸ“Š æ•°æ®é›†é…ç½®

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `dataset_path` | str | None | æ•°æ®é›†æ–‡ä»¶è·¯å¾„ï¼Œæ”¯æŒ `.json` å’Œ `.jsonl` æ ¼å¼ï¼ˆå¿…å¡«ï¼‰ |
| `cutoff_len` | int | 1024 | æœ€å¤§åºåˆ—é•¿åº¦ï¼ˆtoken æ•°ï¼‰ï¼Œè¶…è¿‡å°†è¢«æˆªæ–­ |

---

### ğŸ“ è®­ç»ƒè¶…å‚æ•°

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `num_epochs` | float | 3.0 | è®­ç»ƒè½®æ•°ï¼Œæ”¯æŒå°æ•°ï¼ˆå¦‚ 0.5 è¡¨ç¤ºåŠä¸ª epochï¼‰ |
| `learning_rate` | float | 5e-5 | å­¦ä¹ ç‡ |
| `weight_decay` | float | 0.01 | æƒé‡è¡°å‡ç³»æ•°ï¼Œç”¨äº L2 æ­£åˆ™åŒ– |
| `warmup_ratio` | float | 0.1 | é¢„çƒ­æ­¥æ•°æ¯”ä¾‹ï¼Œå æ€»è®­ç»ƒæ­¥æ•°çš„ç™¾åˆ†æ¯” |
| `lr_scheduler_type` | str | "cosine" | å­¦ä¹ ç‡è°ƒåº¦å™¨ç±»å‹ï¼š`linear`ã€`cosine`ã€`cosine_with_restarts`ã€`polynomial`ã€`constant`ã€`constant_with_warmup`ã€`inverse_sqrt`ã€`reduce_on_plateau`ã€`cosine_with_min_lr`ã€`warmup_stable_decay` ç­‰ |
| `enable_gradient_checkpointing` | bool | False | æ˜¯å¦å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼ˆé™ä½æ˜¾å­˜å ç”¨ï¼Œä½†ä¼šå¢åŠ è®­ç»ƒæ—¶é—´ï¼‰ |

---

### ğŸ’¾ æ‰¹æ¬¡å¤§å°

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `train_micro_batch_size_per_gpu` | int | 4 | æ¯ä¸ª GPU çš„å¾®æ‰¹æ¬¡å¤§å° |
| `gradient_accumulation_steps` | int | 8 | æ¢¯åº¦ç´¯ç§¯æ­¥æ•°<br>**å…¨å±€æ‰¹æ¬¡å¤§å°** = `micro_batch_size Ã— GPUæ•° Ã— gradient_accumulation_steps` |

---

### ğŸ”¢ ç²¾åº¦è®¾ç½®

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `train_model_precision` | str | "bf16" | è®­ç»ƒç²¾åº¦ï¼š`fp32`ï¼ˆ32ä½æµ®ç‚¹ï¼‰ã€`fp16`ï¼ˆ16ä½æµ®ç‚¹ï¼‰ã€`bf16`ï¼ˆBrain Float16ï¼‰ |

---

### ğŸš€ DeepSpeed å’Œåˆ†å¸ƒå¼

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `deepspeed_config_path` | str | None | DeepSpeed é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆæ¨èä½¿ç”¨ï¼‰ |
| `num_local_io_workers` | int | None | æœ¬åœ° IO å·¥ä½œçº¿ç¨‹æ•° |
| `average_tokens_across_devices` | bool | False | æ˜¯å¦åœ¨è®¾å¤‡é—´å¹³å‡ token æ•°ï¼ˆç”¨äºè´Ÿè½½å‡è¡¡ï¼‰ |
| `local_rank` | int | -1 | åˆ†å¸ƒå¼è®­ç»ƒçš„æœ¬åœ° GPU ç¼–å·ï¼ˆç”± DeepSpeed è‡ªåŠ¨è®¾ç½®ï¼‰ |

**DeepSpeed é…ç½®é€‰æ‹©ï¼š**

| é…ç½®æ–‡ä»¶ | ZeRO é˜¶æ®µ | æ˜¾å­˜ä¼˜åŒ– | é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ |
|---------|----------|---------|------|---------|
| `ds_z0_config.json` | Stage 0 | æ—  | æœ€å¿« | å°æ¨¡å‹ï¼Œæ˜¾å­˜å……è¶³ |
| `ds_z1_config.json` | Stage 1 | ä¼˜åŒ–å™¨çŠ¶æ€åˆ†ç‰‡ | å¿« | ä¸­ç­‰æ¨¡å‹ |
| `ds_z2_config.json` | Stage 2 | ä¼˜åŒ–å™¨+æ¢¯åº¦åˆ†ç‰‡ | ä¸­ç­‰ | å¤§æ¨¡å‹ |
| `ds_z3_config.json` | Stage 3 | å…¨éƒ¨å‚æ•°åˆ†ç‰‡ | è¾ƒæ…¢ | è¶…å¤§æ¨¡å‹ï¼Œæ˜¾å­˜ä¸è¶³ |

---

### ğŸ’¾ ä¿å­˜å’Œæ£€æŸ¥ç‚¹

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `save_steps` | int | 500 | æ¯éš”å¤šå°‘æ­¥ä¿å­˜ä¸€æ¬¡æ£€æŸ¥ç‚¹ |
| `save_total_limit` | int | 3 | æœ€å¤šä¿ç•™å¤šå°‘ä¸ªæ£€æŸ¥ç‚¹ï¼ˆæ—§çš„ä¼šè¢«åˆ é™¤ï¼‰ |
| `save_last` | bool | False | æ˜¯å¦åœ¨è®­ç»ƒç»“æŸæ—¶ä¿å­˜æœ€åä¸€ä¸ªæ£€æŸ¥ç‚¹ |

---

### ğŸ“ˆ æ—¥å¿—é…ç½®

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `logging_steps` | int | 1 | æ¯éš”å¤šå°‘æ­¥è®°å½•ä¸€æ¬¡æ—¥å¿— |
| `save_train_log` | bool | False | æ˜¯å¦å°†è®­ç»ƒæ—¥å¿—ä¿å­˜åˆ°æ–‡ä»¶ |
| `use_tensorboard` | bool | False | æ˜¯å¦å¯ç”¨ TensorBoard æ—¥å¿— |

---

### ğŸ”§ LoRA é…ç½®

> ä»…å½“ `finetuning_type="lora"` æ—¶éœ€è¦é…ç½®

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `lora_rank` | int | 64 | LoRA çš„ç§©ï¼ˆrankï¼‰ï¼Œæ§åˆ¶é€‚é…å™¨çš„å¤§å° |
| `lora_alpha` | int | 128 | LoRA çš„ç¼©æ”¾ç³»æ•°ï¼Œé€šå¸¸è®¾ä¸º `rank Ã— 2` |
| `lora_dropout` | float | 0.1 | LoRA å±‚çš„ dropout æ¯”ä¾‹ |
| `lora_target_modules` | list | None | åº”ç”¨ LoRA çš„ç›®æ ‡æ¨¡å—ï¼Œå¦‚ `["q_proj", "v_proj"]` |

---

### ğŸ¯ DPO ç‰¹å®šå‚æ•°

> ä»…å½“ `training_stage="dpo"` æ—¶ä½¿ç”¨

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `pref_beta` | float | 0.1 | DPO æŸå¤±çš„ beta ç³»æ•°ï¼Œæ§åˆ¶åå¥½å¼ºåº¦ |
| `dpo_label_smoothing` | float | 0.0 | æ ‡ç­¾å¹³æ»‘ç³»æ•° |
| `sft_weight` | float | 0.0 | SFT æŸå¤±æƒé‡ï¼ˆä¸ DPO æŸå¤±æ··åˆæ—¶ä½¿ç”¨ï¼‰ |
| `ld_alpha` | float | 1.0 | LDï¼ˆLength Differenceï¼‰æŸå¤±çš„ alpha ç³»æ•° |

---

## æ¨ç†å‚æ•°

### ğŸ¤– æ¨¡å‹åŠ è½½é…ç½®

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `yaml_config` | str | "" | YAML é…ç½®æ–‡ä»¶è·¯å¾„ |
| `model_path` | str | None | æ¨¡å‹è·¯å¾„ï¼ˆå¿…å¡«ï¼‰ |
| `device_map` | str | "auto" | è®¾å¤‡æ˜ å°„ï¼š`auto`ï¼ˆè‡ªåŠ¨ï¼‰ã€`cpu`ã€`cuda:0` ç­‰ |
| `dtype` | str | "auto" | æ¨¡å‹æ•°æ®ç±»å‹ï¼š`auto`ã€`torch.float16`ã€`torch.bfloat16` ç­‰ |
| `training_stage` | str | "sft" | æ¨¡å‹è®­ç»ƒé˜¶æ®µï¼š`sft`ã€`dpo`ã€`pretrain` |

---

### ğŸ’¬ å¯¹è¯åŸºç¡€é…ç½®

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `system_prompt` | str | None | ç³»ç»Ÿæç¤ºè¯ï¼Œç”¨äºè®¾å®šæ¨¡å‹è§’è‰²å’Œè¡Œä¸º |
| `enable_history` | bool | False | æ˜¯å¦å¯ç”¨å¤šè½®å¯¹è¯å†å²è®°å¿† |
| `max_new_tokens` | int | None | æœ€å¤§ç”Ÿæˆ token æ•°ï¼ˆNone è¡¨ç¤ºä½¿ç”¨æ¨¡å‹é»˜è®¤å€¼ï¼‰ |

---

### ğŸ² é‡‡æ ·ç”Ÿæˆå‚æ•°

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `do_sample` | bool | False | æ˜¯å¦å¯ç”¨é‡‡æ ·ï¼ˆFalse è¡¨ç¤ºè´ªå©ªè§£ç ï¼‰ |
| `temperature` | float | None | é‡‡æ ·æ¸©åº¦ï¼Œæ§åˆ¶ç”Ÿæˆéšæœºæ€§<br>- è¾ƒä½å€¼ï¼ˆ0.1-0.5ï¼‰ï¼šæ›´ç¡®å®šæ€§<br>- è¾ƒé«˜å€¼ï¼ˆ0.7-1.5ï¼‰ï¼šæ›´æœ‰åˆ›é€ æ€§ |
| `top_k` | int | None | Top-K é‡‡æ ·ï¼Œåªä»æ¦‚ç‡æœ€é«˜çš„ K ä¸ª token ä¸­é‡‡æ · |
| `top_p` | float | None | Top-Pï¼ˆNucleusï¼‰é‡‡æ ·ï¼Œç´¯è®¡æ¦‚ç‡è¾¾åˆ° P æ—¶åœæ­¢ |
| `repetition_penalty` | float | None | é‡å¤æƒ©ç½šç³»æ•°ï¼Œå€¼ >1.0 å‡å°‘é‡å¤<br>- 1.0ï¼šæ— æƒ©ç½š<br>- 1.2ï¼šè½»åº¦æƒ©ç½š<br>- 1.5+ï¼šé‡åº¦æƒ©ç½š |

---

### ğŸŒ Web æœåŠ¡é…ç½®ï¼ˆä»… BumbleChat ä½¿ç”¨ï¼‰

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `host` | str | "127.0.0.1" | Web æœåŠ¡å™¨ç›‘å¬åœ°å€<br>- `127.0.0.1`ï¼šä»…æœ¬æœºè®¿é—®<br>- `0.0.0.0`ï¼šå…è®¸å¤–éƒ¨è®¿é—® |
| `port` | int | 8000 | Web æœåŠ¡å™¨ç«¯å£å· |
